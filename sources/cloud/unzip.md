压缩解压缩服务是对**已经上传到又拍云存储中的文件**进行压缩或解压缩处理，并将处理后的文件存储到用户指定的位置。由于服务是异步进行的，结果状态会在处理完成后以回调的方式通知用户。如果文件不在又拍云存储中，需要预先调用文件上传 API 将压缩文件上传至又拍云存储。

> 注：文中所有 `<>` 标注的字段，均需根据实际情况进行替换。

## 使用方法

### 请求方法

以 `POST` 方式向 `http://p0.api.upyun.com/pretreatment/` 提交处理请求，又拍云接受请求后立即返回任务的 `task_id`，处理完成后通过回调的方式通知用户。

例如：

```
curl -X POST \
    http://p0.api.upyun.com/pretreatment/ \
    -H "Authorization: UPYUN <operator>:<signature>" \
    -H "Date: <Wed, 29 Oct 2014 02:26:58 GMT>"
    -d "bucket_name=<bucket_name>" \
    -d "notify_url=<notify_url>" \
    -d "app_name=<app_name>" \
    -d "tasks=<base64 编码后的任务字符串>"
```

### 请求参数

|        参数       |    类型       | 必选     |   说明                           |
|-------------------|--------------|------|---------------------------------------|
| bucket_name       | string       |  是   | 文件所在服务名                     |
| notify_url        | string       |  是   | 回调通知地址                         |
| tasks             | string       |  是   | 处理任务信息，详见下                 |
| app_name          | string       |  是   | 处理方式，压缩为 `compress`，解压缩为 `depress`      |


`tasks` 参数通过下面三个步骤生成：

1\. 组装业务参数。一次最多可以提交 10 个**相同**（同为压缩或同为解压缩）的处理任务。

```
[
	{
		"sources": ["/a/1.pdf","/a/b/"],     //需要压缩的文件路径
		"save_as": "/result/abc.zip"         //保存路径
	},
  	{
		"sources": ["/e/f","/e/g.jpg"],   		//需要压缩的文件或目录路径
		"save_as": "/result/e.zip"              //保存路径
	},
	…
]
```

2\. 把组装好的参数转换为 JSON 字符串。

3\. 对 JSON 字符串进行 base64 编码处理。

### 授权认证

授权认证的方法与异步音视频处理授权认证方法一致，请参考 [授权认证](/cloud/av/#_4)。


### 回调通知

处理完成后，系统根据提交任务时的 `notify_url` 参数，将处理结果转换成 JSON 字符串，并以 `HTTP POST` 请求进行回调通知。

** 回调通知参数 **

|        参数       |    类型   |    说明                                                                                                      |
|-------------------|-----------|--------------------------------------------------------------------------------------------------------------|
| task_id      | string    | 任务对应的 TaskId                             |
| status_code  | integer   | 处理结果状态码，200 表示成功处理              |
| path         | string    | 输出文件保存路径                              |
| error        | string    | 处理错误信息描述，空字符串表示没有错误        |



## 处理参数

### 压缩

将多个文件或文件夹压缩成一个压缩文件。

|        参数       |    类型   |    说明                                                             |
|-------------------|-----------|--------------------------------------------------------------------|
| sources           | array      | 需要被压缩的文件或目录的路径                  |
| save_as           | string     | 文件压缩后的保存路径，如 `/result/t.zip`                                |
| home_dir          | string     | 文件被压缩时可不包含的父目录。默认包含从根开始的全部目录。可选参数 |


注：

- `sources` 内包含的文件最大数量 10000 个，总文件大小 1G。
- 压缩算法: 目前仅支持 `zip`，因此， `save_as` 中文件需要以 `.zip` 作为后缀。
- `home_dir` 会去除指定父目录及父目录下文件，压缩目录层级较深的文件时，可以通过它去除父目录及父目录下文件的干扰。

例如，任务的提交参数如下:

```json
[
	{
		"sources": ["/a/b/c/source/1.jpg","/a/b/c/source/2.jpg"],
		"save_as": "/result/t.zip",
		"home_dir": "a/b/c"	//压缩时，不包含的目录
	}
]
```

则，压缩文件的目录结构如下:（ `a/b/c` 父目录已经不存在了，直接放在 `a/b` 父目录下的文件也已经不存在了）

```
source
|-------1.jpg
|-------2.jpg
```


### 解压缩

将云存储上的压缩文件解压到指定目录。

|        参数       |    类型   |    说明                                         |
|-------------------|-----------|-----------------------------------------------|
| sources           | string    | 压缩文件的路径                                  |
| save_as           | string    | 文件解压缩后的保存路径（需要为目录），如 `/result/`    |

注：

- `sources` 内包含的文件最大大小为 5G。
- 解压算法: 目前仅支持 `zip`，因此， `sources` 指定压缩文件须是 zip 文件。
- 解压缩后的目录中，会增加一个以 `task_id` 命名的记录了所有解压文件信息的文件。

