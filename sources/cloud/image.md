## 5分钟了解

又拍云提供基于云的图片处理，使用简单，API 丰富（支持服务端 API、客户端表单 API、分块上传 API），功能完善（图片缩小&放大、裁剪、水印、旋转、格式转换、大小压缩优化等）。

下面来看看怎么使用。

### 访问图片处理

假设图片路径 `http://demo.b0.upaiyun.com/demo.jpg`，需要对图片旋转90°

图片处理URL 是 `http://demo.b0.upaiyun.com/demo.jpg!/rotate/90`

`/rotate/90` 表示图片旋转90°， `!` 表示间隔标识符。

通过在图片路径后面，以 `/key/value` 的方式追加处理参数，实现图片处理。

### 间隔标识符

间隔标识符用于分隔图片 URL 、图片处理参数。

间隔标识符包含  `!(默认)` 、 `-(中划线)` 、 `_(下划线)` ，后续图片处理案例使用  `!(感叹号)` 作为间隔标识符。

修改间隔标识符，请登录又拍云管理平台。

### 图片上传预处理
通过 API 或 SDK 把图片上传到又拍云存储。API 有 `HTTP REST API`、`HTTP FORM API`、`分块上传 API`。

图片上传时附加图片处理参数，系统会先处理图片，然后再把处理结果图片存储起来，同时删除上传原图。如果没有附加图片处理参数，直接存储原图。

图片处理参数以 `/key/value` 的方式，放入图片上传请求中。

假设转换图片格式为png，参数为： `/format/png`

则上传请求中增加 `x-gmkerl-thumb:/format/png`

假设对上传图片宽度缩小为 300px、锐化、压缩质量 80、输出格式 png，参数为： `/fw/300/unsharp/true/quality/80/format/png`  （多个参数不区分先后顺序）

则上传请求中增加 `x-gmkerl-thumb:/fw/300/unsharp/true/quality/80/format/png`

表单上传图片（HTTP FORM API）异步处理，支持原图保存：

```
"save_key": "path/to/save/your/upload/image"，   //原图保存路径
"notify_url": "http://callback/url", 	//回调通知
"apps": [
  {
    "app_name": "thumb",			//图片处理
    "x-gmkerl-thumb": "/format/png"，//图片处理参数
    "save_as": "path/to/save/process/result/image",  //处理结果图片保存路径
  }
]
```

上传后，系统返回一个 `task_ids:[“xxx”]`，`xxx` 表示异步处理任务的 `id`，处理完成后通过`notify_url` 发起回调。

表单上传图片（HTTP FORM API）实时处理，不保存原图：

```
"save_key": "path/to/save/your/image"，    //处理结果图片保存路径
"x-gmkerl-thumb": /format/png，		//图片处理参数
"notify_url": "http://callback/url", 	//回调通知
```

### 缩略图版本（样式）

如果你觉得 `/fw/300/unsharp/true/quality/80/format/png` 太长，可以在又拍云管理平台 -> 云处理 -> 创建缩略图版本。

使用时，把缩略图版本名称追加在图片 URL 后。

图片 URL：`http://demo.b0.upaiyun.com/demo.jpg`，缩略图版本名称 `test`

图片处理的 URL 是：`http://demo.b0.upaiyun.com/demo.jpg!test`

也就是：`test = /fw/300/unsharp/true/quality/80/format/png`

如果是图片上传预处理时，则 `x-gmkerl-thumb: test`


### 高级应用

缩略图版本（样式）后加 `/key/value`。听着有些拗口，直接来看个栗子。

图片 URL：`http://demo.b0.upaiyun.com/demo.jpg`

缩略图版本 `test` ，另外还需要对图片进行 `/rotate/auto（自动旋转扶正）`。

则URL 是：`http://demo.b0.upaiyun.com/demo.jpg!test/rotate/auto`

如果 `test` 中也存在旋转，比如 `/rotate/90` ，会与跟在后面的参数 `/rotate/auto` 重复，处理程序会忽略样式 `test`中的 `/rotate/90 `，以最后出现的相同参数为准。

如果是图片上传预处理时，则 `x-gmkerl-thumb: test/rotate/auto`

## 基本功能

这是一组图片处理的基础功能。

### 缩小&放大

|  参数      |     值           |          说明                                    |
|-----------|----------------- |-------------------------------------------------|
| `/fw/`    | 宽，如 300        | 限定宽度，高度自适应                                |
| `/fh/`    | 高，如 200        | 限定高度，宽度自适应                                 |
| `/fwfh/`  | 宽x高，如 300x200  | 限定宽度或高度，宽高不足时不缩放                       |
| `/both/`  | 宽x高，如 300x200  | 固定宽度和高度，宽高不足时强行缩放                     |
| `/sq/`    | 宽/高，如 300      | 图片缩略成正方形，宽高相等                            |
| `/max/`   | 最长度值，如 200    | 限定最长边，短边自适应                               |
| `/min/`   | 最短边值，如 200    | 限定最短边，长边自适应                               |
| `/scale/` | 缩小百分比值，如 50  | 等比例缩小，缩小至原图的百分比宽高大小，取值范围[1-99]   |


注1：`/scale/` 值取 `1` 时，缩小后的图片宽高是原图宽高的 1%；取 `99` 时，缩小后的图片宽高是原图宽高的 99%。


### 裁剪

|  参数      |     值                                             |          说明                                                            |
|-----------|-------------------------------------------------- |------------------------------------------------------------------------- |
| `/crop/`  | `<width>x<height>a<x>a<y>` 如 `300x200a80a60`       | 裁剪，`<width>`、`<height>` 分别表示裁剪图片宽、高，`<x>`、`<y>` 分别表示左上角坐标 |
| `/clip/`  | `<width>x<height>a<x>a<y>` 如 `300x200a80a60`       | 裁剪，`<width>`、`<height>` 分别表示裁剪图片宽、高，`<x>`、`<y>` 分别表示左上角坐标 |

建议使用 `crop` 。`crop` 先做缩放再裁剪，`clip` 先做裁剪再缩放。

注1：`<width>x<height>` 中的 `x`，是英文字母 `x`。

注2：`width > 0`，`height > 0` ，`x >= 0` ，`y >= 0`。


### 水印

#### 图片水印

|  参数          |     值                                    |          说明                                                         |
|---------------|------------------------------------------ |----------------------------------------------------------------------|
| `/watermark/` |                                           | 水印类型                                              |
| `/url/`       | 水印图片 URL，如`L2EvYi5qcGc=（/a/b.jgp）`   | 水印图片 url，编码见注 1                                                  |
| `/align/`     | 位置，如 north                              | 水印图片的对齐方式，默认 northwest 注2                                     |
| `/margin/`    | 宽 x 高，如15x10                            | 水印图片预留长宽，默认 20x20                                               |
| `/opacity/`   | 透明度，如90                                 | 水印图片透明度，默认 100 取值范围：0-100，值越大越不透明，0完全透明，100完全不透明 |
| `/animate/`   | true (boolean)                             | 允许对动态图片加水印，默认 false。  |

特别地，水印图片必须放在 domain 或原图 所在服务名下，不支持远程链接。

#### 文字水印

|  参数          |     值                                     |          说明                                                      |
|---------------|------------------------------------------- |--------------------------------------------------------------------|
| `/watermark/` |                                            | 水印类型                                            |
| `/text/`      | 文字内容，如`5L2g5aW977yB（你好！）`           | 水印文字内容，编码见注 1                                               |
| `/size/`      | 大小，如16                                  | 文字大小，单位像素（px）。默认32                                         |
| `/font/`      | 字体，如 simsun（宋体）                       | 文字字体，默认宋体。字体使用时，用参数名。详见 [字体支持列表](/cloud/font/)   |
| `/color/`     | RRGGBB，如 FF0000（红色）                    | 字体颜色，默认000000（黑色）                                            |
| `/border/`    | RRGGBBAA，如FF000000（不透明红色）            | 文字描边，默认 FFFFFFFF（透明白色）注3                                    |
| `/align/`     | 位置，如 north                              | 水印图片的对齐方式，默认 northwest 注2                                    |
| `/margin/`    | 宽 x 高，如15x10                            | 水印图片预留长宽，默认 20x20                                             |
| `/opacity/`   | 透明度，如90                                 | 水印图片透明度，默认 100 取值范围：0-100，值越大越不透明，0完全透明，100完全不透明 |
| `/animate/`   | true (boolean)                             | 允许对动态图片加水印，默认 false。   |

特别地，含中文内容时请指定中文字体。

#### 多个水印

对原图打多个图片水印或文字水印。实现就是把多个图片水印或文字水印参数连在一起。

特别地，水印个数越多，耗时越长。建议不要超过 2 个。

```
图片水印：/watermark/image/L2EvYi9jLmpwZw==/align/north/margin/15x10
文字水印：/watermark/text/5L2g5aW9/size/16/font/5a6L5L2T/color/FF0000/border/FF000000/margin/5x5/align/southeast/opacity/90
多个水印：图片水印+文字水印
/watermark/image/L2EvYi9jLmpwZw==/align/northwest/margin/15x10/watermark/text/5L2g5aW9/size/16/font/5a6L5L2T/color/FF0000/border/FF000000/margin/5x5/align/southeast/opacity/90
```

注1：`url` 内容、`text` 内容需要 base64 编码，并把 /（斜杠）替换成 |（竖线），+（加号）、=（等号）不需替换。

注2：水印的对齐方式：共9个方位

```
     northwest       |      north      |    northeast
      （西北)         |      （北）      |     （东北）
---------------------+-----------------+------------------
        west         |     center      |      east
       （北）         |      （中)       |     （东）
---------------------+-----------------+------------------
     southwest       |     south       |    southeast
      （西南)         |     （南)        |     （东南）
```

注3：`RRGGBBAA` 前面6位 `RRGGBB` 表示边框颜色；后2位 `AA` 表示不透明度，取值 `[0-255]`，值越大越透明，00 表示完全不透明，FF 表示完全透明。

### 旋转

|  参数        |     值                  |          说明               |
|-------------|------------------------|---------------------------- |
| `/rotate/`  | auto                   | 旋转扶正图片，使图片能正常观看。  |
| `/rotate/`  | `(0,360°]`，如90°       | 按角度旋转                    |

### 原图保护

对原图进行秘钥保护，访问时需要秘钥才能访问到原图，否则，返回 404（图片找不到）。

支持源站类型：`UPYUN 存储`

假设文件保护秘钥为 `abc`，图片路径为 `http://demo.b0.upaiyun.com/demo.jpg`。

对原图的访问方式是 `http://demo.b0.upaiyun.com/demo.jpg!abc`， `abc` 表示文件保护秘钥。

如果缩略图版本名称（样式）和原图保护秘钥相同时，原图保护秘钥优先级高于缩略图版本号。


## 图片渲染

这是一组跟图片美化相关的功能。

### 锐化

提高图片模糊部位的清晰度或聚焦程度。

|  参数        |     值                  |          说明               |
|-------------|------------------------|---------------------------- |
| `/unsharp/` | true (boolean)         | 锐化                         |

### 高斯模糊

减少图片噪音以及降低图片细节层次，让图片模糊化。

|  参数          |     值                     |          说明                            |
|---------------|----------------------------|---------------------------------------- |
| `/gaussblur/` | `<radius>x<sigma>`，如5x2   | 高斯模糊，radius 为模糊半径，sigma 为标准差  |

其中，`<radius>x<sigma>`中的 `x`，是英文字母 `x`。

注1：`0 =< radius <= 50` 且 `radius` 是整数；当 `radius = 0` 时，`raduis` 根据 `sigma` 自动计算产生。

注2：`sigma` 是正整数（`sigma > 0 && sigma 是整数`）。

### 边框
为图片添加边框，支持设置边框颜色。

|  参数          |     值                        |          说明                              |
|---------------|-------------------------------|------------------------------------------ |
| `/border/`    | `<width>x<height>`，如3x2      | 边框，width表示边框宽度，height表示边框高度     |
| `/brdcolor/`  | RRGGBBAA，如FF000000(红色不透明) | 边框颜色和透明度，默认值是FFFFFF00（白色不透明） |

注1：`RRGGBBAA` 前面6位 `RRGGBB` 表示边框颜色；后2位 `AA` 表示不透明度，取值`[0-255]`，值越大越透明，00 表示完全不透明，FF 表示完全透明。

### 画布

为图片添加画布，相当于把图片放入背景布中。

|  参数          |     值                                  |          说明                                            |
|---------------|-----------------------------------------|-------------------------------------------------------- |
| `/canvas/`    | `<width>x<height>axay`，如600x400a50a20  | 画布，其中width表示画布宽；height表示画布高；x、y表示左上角坐标  |
| `/cvscolor/`  | RRGGBBAA，如FF000000(红色不透明)           | 边框颜色和透明度，默认值是FFFFFF00（白色不透明）               |

注1：`RRGGBBAA` 前面6位 `RRGGBB` 表示边框颜色；后2位 `AA` 表示不透明度，取值 `[0-255]` ，值越大越透明，00 表示完全不透明，FF 表示完全透明。


### 静态图渐变

为静态图片添加渐变效果。

|  参数             |     值                             |          说明                       |
|------------------|------------------------------------|------------------------------------|
| `/gdori/`        | 方向，如top-down（自上而下）           | 渐变方向，取值见注 1                  |
| `/gdpos/`        | 开始位置,结束位置，如10,100            | 渐变从开始位置至结束位置。单位像素（px）  |
| `/gdstartcolor/` | RRGGBBAA，如FF000000(红色不透明)      | 开始位置颜色及透明度，取值见注 2        |
| `/gdstopcolor/`  | RRGGBBAA，如FF000000(红色不透明)      | 开始位置颜色及透明度，取值见注 2        |

注1：`gdori` 方向： `top-down`（自上而下）、 `bottom-up`（自下而上）、`left-right`（自左向右）、 `right-left`（自右向左）。

注2：`RRGGBBAA` 前面6位 `RRGGBB` 表示边框颜色；后2位 `AA` 表示不透明度，取值 `[0-255]`，值越大越透明，00 表示完全不透明，FF 表示完全透明。

## 属性获取

这是一组获取图片信息的功能

### 基本信息

|  参数        |     值             |          说明             |
|-------------|--------------------|-------------------------- |
| `/info`     |                    | 图片宽高、格式、帧数       |

特别地，上传预处理原生返回基本信息。

### EXIF 信息

|  参数        |     值             |          说明             |
|-------------|--------------------|-------------------------- |
| `/meta`     |                    | EXIF 信息 + 基本信息       |

特别地，上传预处理通过 `x-gmkerl-type: get_meta` 返回。

### 主题色提取

|  参数             |     值                 |          说明                                        |
|------------------|------------------------|-----------------------------------------------------|
| `/excolor/`      | 颜色数量，如128          | 提取的颜色数量，默认 256 种。可选值：1-4096种             |
| `/exformat/`     | 颜色进制，如 hex         | 返回颜色的进制，默认hex。可选值：dec(十进制)，hex(十六进制)  |

以JSON格式返回颜色。hex（十六进制）表示颜色为 `#RRGGBB`，dec（十进制）表示颜色为 `xxxxxxxx`（八位数字），如 `13408614`。

特别地，上传预处理通过 `x-gmkerl-type: get_theme_color` 返回。自定义颜色数量通过 `x-gmkerl-extract-color-count: 颜色数量` 设置， 自定义颜色进制通过 `x-gmkerl-extract-format: hex`  设置。

## 结果输出

这是一组影响图片输出格式、大小的功能

### 格式

|  参数        |     值             |          说明             |
|-------------|--------------------|-------------------------- |
| `/format/`  |  jpg、png、webp     | 输出格式                   |

### 质量

|  参数        |     值             |          说明               |
|-------------|--------------------|-----------------------------|
| `/quality/`  | 整数值，如75        | 设置压缩质量，可选范围`[1-99]`  |

一般的，最佳质量值是 75，在这个值压缩大小与图片质量损失得到平衡。

### 图片大小优化

|  参数         |     值             |          说明               |
|--------------|--------------------|-----------------------------|
| `/compress/` | true (boolean)     | 支持格式：JPG、PNG            |

再进行一次压缩以减少图片体积，会稍微延长图片处理时间。

### JPG 图片渐进式加载

|  参数            |     值             |          说明               |
|-----------------|--------------------|-----------------------------|
| `/progressive/` | true (boolean)     | JPG 图片渐进式加载             |

### 清除 ICC 信息

|  参数         |     值             |          说明               |
|--------------|--------------------|-----------------------------|
| `/noicc/`    | true (boolean)     | 清除图片 ICC 信息，默认 false  |

注1：清除 `ICC` 信息会导致图片轻微的失真。

## 扩展功能

### 动态 GIF 转换成静态图片

|  参数         |     值             |          说明               |
|--------------|--------------------|-----------------------------|
| `/gifto/`    | true (boolean)     | 多帧 gif 图片转为单帧 gif 图片  |

### 保留 EXIF 信息

|  参数           |     值             |          说明               |
|----------------|--------------------|-----------------------------|
| `/exifswitch/` | true (boolean)     | 保留 EXIF 信息               |

保留 `EXIF` 信息，但不返回 `EXIF` 信息。如果需要获取 `EXIF` 信息，请[获取 EXIF 信息](#exif)

特别地，图片处理默认情况下删除 `EXIF` 信息。

### 翻转

|  参数         |     值             |          说明                        |
|--------------|--------------------|--------------------------------------|
| `/flip/`     | 方向，如left-right   | 翻转方向，可选值：left-right，top-down  |

`left-right`：从左向右翻转，`top-down`：从上向下翻转。
