## 使用方法

### URL 作图

将作图参数追加在原图 URL 后面，即可访问到作图后的图片。

例如原图路径是 `http://demo.b0.upaiyun.com/demo.jpg`，需要访问旋转 90 度后的图片，那么只需要访问 `http://demo.b0.upaiyun.com/demo.jpg!/rotate/90` 即可。
其中 `/rotate/90` 是作图参数，表示对图片旋转 90 度；`!` 表示间隔标识符，用于区分原图 URL 和作图参数。同理，如果希望对原图进行旋转 180 度操作，那么只需要在原图 URL 后面加上 `!/rotate/180` 即可。

通过在图片 URL 后面以 `!/key1/value1/key2/value2/key3/value3` 的方式追加多个作图参数，可以实现对图片的多种处理。

例如，对 `http://demo.b0.upaiyun.com/demo.jpg` 这张图片旋转 90 度并且加上绿色的文字水印『你好又拍云』，可以访问以下地址：

```
http://demo.b0.upaiyun.com/demo.jpg!/rotate/90/watermark/text/5L2g5aW95Y+I5ouN5LqR/color/00ff00
```

详细作图参数请见 [这里](/cloud/image/#_5)

注：
> - **间隔标识符** 用于分隔图片 URL 和图片处理参数。可登录又拍云管理平台选择 `!(英文感叹号)` 、 `-` 、 `_` 中的任意一种 ，本文档使用 `!` 作为示例间隔标识符。
>
> - 作图参数需要加在原图文件名后面而不是 URL 参数后面。例如 URL 是 `http://demo.b0.upaiyun.com/demo.jpg?foo=1&bar=2`，则加上作图参数后的 URL 应该是
> `http://demo.b0.upaiyun.com/demo.jpg!/rotate/90?foo=1&bar=2`。
>


### 上传作图

#### 上传同步作图

在上传图片到 UPYUN 的时候，可以在请求中带上相应的图片处理参数，那么 UPYUN 会先根据作图参数对图片进行相应的处理，然后将处理后的图片保存到 UPYUN 存储。

上传作图的参数名为 `x-gmkerl-thumb`，在使用 REST API 进行上传时，该参数需要带在 [http 请求头](/api/rest_api/#_6) 里，而在使用表单 API 进行上传时，该参数应该包含在 [policy](/api/form_api/#api_1) 中。参数的值与 URL 作图方式相同。以下为几个上传作图的参数示例：

例1：转换图片格式为 png
```
x-gmkerl-thumb: /format/png
```

例2：限定图片宽度为 300px、锐化、压缩质量 80、存储为 png 格式（参数不区分先后顺序）
```
x-gmkerl-thumb: /fw/300/unsharp/true/quality/80/format/png
```

详细作图参数请见 [这里](/cloud/image/#_5)


#### 上传异步作图

在 [表单 API](/api/form_api/#api_1) 的 `apps` 参数里添加异步作图任务，并指定任务名称为 `thumb`，即可实现在上传图片之后发起 [异步图片处理任务](/api/form_api/#_4)。特别地，上传异步作图可以通过表单 API 的 `save_key` 参数保存上传的原图。

异步处理任务的参数及说明如下：
```
{
    "name": "thumb",  // 需要指定 name 为 thumb
    "x-gmkerl-thumb": "<图片处理参数，与上传作图或 URL 作图相同>",
    "save_as": "<图片处理后的存放地址>",
    "notify_url": "<异步作图完成后的回调地址>"
}
```

异步图片处理完成后的回调信息为 json 格式，字段名及含义如下：

|  字段名       |     示例值             |          说明             |
|-------------|--------------------|-------------------------- |
| `taskid`  |  `b52c96bea30646abf8170f333bbd42b9`    | 异步处理任务 id（在上传时返回）                  |
| `path`    |   `/a/b/c/d.jpg`    |   作图结果保存路径（`save_as`参数指定）         |
| `type`    |   `jpg`, `png`    |    图片类型        |
| `width`    |   `100`    |    图片宽度        |
| `height`    |   `200`    |   图片高度         |
| `frame`    |   `1`    |     图片桢数       |



### 缩略图版本（样式）

如果你觉得 `/fw/300/unsharp/true/quality/80/format/png` 太长，可以在*又拍云管理平台 -> 选择服务 -> 功能配置 -> 云处理 -> 自定义版本 -> 创建缩略图版本*来为常用的作图参数配置一个缩略图版本。之后，就可以使用缩略图版本来替代冗长的作图参数。

例如我们为 `/fw/300/unsharp/true/quality/80/format/png` 配置了一个缩略图版本名称为 `test`，那么之后就可以通过 `http://demo.b0.upaiyun.com/demo.jpg!test` 
来进行 URL 作图，或者在上传图片时指定 `x-gmkerl-thumb: test` 参数来进行上传作图。通过缩略图版本与通过原始的作图参数处理后的结果是等效的。

注：
>
> 作图参数是以 `/` 开头的，如 `/fw/100/quality/90`，而缩略图版本不是以 `/` 开头的。上例中如果错误地指定了 `!/test` 为 URL 作图参数则访问会返回 *400 参数错误*。


### 混合作图参数

上例中，我们配置了 `test` 这个缩略图版本，会对图片进行限定宽度 300px 的操作（`/fw/300`）。而我们临时想把某张图片宽度限定在 100px，如果要修改或重新创建个版本号不免显得有些麻烦。

UPYUN 提供了缩略图版本与作图参数混合的作图方式，允许用户在使用时对缩略图版本做动态的调整，而无需修改或创建新的缩略图版本。

例如，我们通过访问 `http://demo.b0.upaiyun.com/demo.jpg!test/fw/100` 就可以实现 `/fw/100/unsharp/true/quality/80/format/png` 的作图效果。同样地，在上传作图时，也可以类似地带上 `x-gmkerl-thumb: test/fw/100` 参数来动态地改变 `test` 版本中的参数值。 


## 作图参数

### 基本参数

#### 缩略

|  参数     |     值                |          说明                                            |
|-----------|-----------------------|----------------------------------------------------------|
| `/fw/`    | 宽，如 300            | 限定宽度，高度自适应                                     |
| `/fh/`    | 高，如 200            | 限定高度，宽度自适应                                     |
| `/fwfh/`  | 宽x高，如 300x200     | 限定宽度或高度，宽高不足时不缩放                         |
| `/both/`  | 宽x高，如 300x200     | 固定宽度和高度，宽高不足时强行缩放                       |
| `/sq/`    | 宽/高，如 300         | 图片缩略成正方形，宽高相等                               |
| `/max/`   | 最长度值，如 200      | 限定最长边，短边自适应                                   |
| `/min/`   | 最短边值，如 200      | 限定最短边，长边自适应                                   |
| `/scale/` | 缩小百分比值，如 50   | 等比例缩小，缩小至原图的百分比宽高大小，取值范围 [1-99]  |


注：
> `/scale/` 值取 `1` 时，缩小后的图片宽高是原图宽高的 1%；取 `99` 时，缩小后的图片宽高是原图宽高的 99%。


#### 裁剪

|  参数     |     值                                            |          说明                                                            |
|-----------|-------------------------------------------------- |------------------------------------------------------------------------- |
| `/crop/`  | `<width>x<height>a<x>a<y>` 如 `300x200a80a60`     | 图片缩略前裁剪，`<width>`、`<height>` 分别表示裁剪图片宽、高，`<x>`、`<y>` 分别表示左上角坐标 |
| `/clip/`  | `<width>x<height>a<x>a<y>` 如 `300x200a80a60`     | 图片缩略后裁剪，`<width>`、`<height>` 分别表示裁剪图片宽、高，`<x>`、`<y>` 分别表示左上角坐标 |

注：
> - `<width>x<height>` 中的 `x`，是英文字母 `x`。
>
> - `width > 0`，`height > 0`，`x >= 0`，`y >= 0`。


#### 水印

> **水印参数需要以 `/watermark` 开头，然后加上水印参数。**如 `/watermark/text/5L2g5aW977yB`。

** 图片水印 **

|  参数         |     值                                            |          说明                                                        |
|---------------|---------------------------------------------------|---------------------------------------------------------------------------|
| `/url/`       | 编码字符串，如 `L3BhdGgvdG8vd2F0ZXJtYXJrLnBuZw==` | 水印图片 url，示例中为 `/path/to/watermark.png` 的编码字符串 *「注 1」*   |
| `/align/`     | 位置，如 north                                    | 水印图片的对齐方式，默认 northwest *「注 4」*                                     |
| `/margin/`    | 宽x高，如 15x10                                   | 水印图片预留长宽，默认 20x20                                               |
| `/opacity/`   | 透明度，如 90                                     | 水印图片透明度，默认 100，取值范围：[0-100]，值越大越不透明，0 完全透明，100 完全不透明 |
| `/animate/`   | true                                              | 允许对动态图片加水印，默认 false  |


** 文字水印 **

|  参数         |     值                                     |          说明                                                      |
|---------------|------------------------------------------- |--------------------------------------------------------------------|
| `/text/`      | 文字内容，如 `5L2g5aW977yB`                | 水印文字内容，示例中为 `你好！`的编码字符串。 *「注3」*                       |
| `/size/`      | 大小，如 16                                | 文字大小，单位像素（px），默认 32                                              |
| `/font/`      | 字体，如 simsun（宋体）                    | 文字字体，默认宋体。字体使用时，用参数名。详见 [字体支持列表](/cloud/attachment/#_3)  *「注2」*|
| `/color/`     | RRGGBB，如 FF0000（红色）                  | 字体颜色，默认 000000（黑色）                                            |
| `/border/`    | RRGGBBAA，如 FF000000（不透明红色）        | 文字描边，默认 FFFFFFFF（透明白色）*「注5」*                                   |
| `/align/`     | 位置，如 north                             | 水印图片的对齐方式，默认 northwest *「注4」*                                    |
| `/margin/`    | 宽x高，如 15x10                            | 水印图片预留长宽，默认 20x20                                             |
| `/opacity/`   | 透明度，如 90                              | 水印图片透明度，默认 100，取值范围：[0-100]，值越大越不透明，0 完全透明，100 完全不透明 |
| `/animate/`   | true                                       | 允许对动态图片加水印，默认 false   |


** 多个水印 **

通过指定多个 `/watermark` 参数，可以在原图上打上多个图片水印或文字水印。例如指定以下参数：

```
/watermark/text/5L2g5aW977yB/font/simhei/watermark/url/L3BhdGgvdG8vd2F0ZXJtYXJrLnBuZw==/align/center/opacity/50
```

就可以打上一个文字水印和一个图片水印。当然，水印个数越多，耗时越长，建议不要超过 2 个。

>
> 注 1：水印图片必须放在原图所在服务名下，不支持外部链接。`url` 需要 base64 编码，并把 `/`（斜杠）替换成 `|`（竖线）。
>
> 注 2：含中文内容时请指定中文字体。
>
> 注 3：`text` 内容需要 base64 编码，并把 `/`（斜杠）替换成 `|`（竖线）。
>
> 注 4：水印的对齐方式：共 9 个方位
>
```
    northwest     |     north      |     northeast
                  |                |
                  |                |
    --------------+----------------+--------------
                  |                |
    west          |     center     |          east
                  |                |
    --------------+----------------+--------------
                  |                |
                  |                |
    southwest     |     south      |     southeast
```
>
> 注 5：`RRGGBBAA` 前面 6 位 `RRGGBB` 表示边框颜色；后 2 位 `AA` 表示不透明度，取值 `[0-255]`，值越大越透明，00 表示完全不透明，FF 表示完全透明。

#### 旋转

|  参数       |     值                  |          说明               |
|-------------|------------------------ |-----------------------------|
| `/rotate/`  | auto                    | 自动扶正                    |
| `/rotate/`  | `(0, 360]`，如 90 度      | 按角度旋转                  |

#### 翻转

|  参数        |     值                |          说明                          |
|--------------|-----------------------|----------------------------------------|
| `/flip/`     | 方向，如 left-right   | 翻转方向，可选值：left-right，top-down |

注：
>
> `left-right`：从左向右翻转，`top-down`：从上向下翻转。


### 图片渲染

#### 锐化

提高图片模糊部位的清晰度或聚焦程度。

|  参数        |     值                 |          说明               |
|--------------|------------------------|-----------------------------|
| `/unsharp/`  | true                   | 锐化，默认 false            |

#### 高斯模糊

减少图片噪音以及降低图片细节层次，让图片模糊化。

|  参数         |     值                      |          说明                               |
|---------------|-----------------------------|---------------------------------------------|
| `/gaussblur/` | `<radius>x<sigma>`，如 5x2  | 高斯模糊，radius 为模糊半径，sigma 为标准差 |

注：
> - 其中，`<radius>x<sigma>`中的 `x`，是英文字母 `x`。
>
> - `0 <= radius <= 50` 且 `radius` 是整数；当 `radius = 0` 时，`raduis` 根据 `sigma` 自动计算产生。
>
> - `sigma` 必须为正整数。

#### 边框

为图片添加边框，支持设置边框颜色。

|  参数         |     值                              |          说明                             |
|---------------|-------------------------------------|-------------------------------------------|
| `/border/`    | `<width>x<height>`，如 3x2          | 边框尺寸，width 表示左右边框宽度，height 表示上下边框宽度     |
| `/brdcolor/`  | RRGGBBAA，如 FF000000（红色不透明） | 边框颜色和透明度，默认值是 FFFFFF00（白色不透明） |

注：

> `RRGGBBAA` 前面6位 `RRGGBB` 表示边框颜色；后2位 `AA` 表示不透明度，取值 `[0-255]`，值越大越透明，00 表示完全不透明，FF 表示完全透明。

#### 画布

为图片添加画布，相当于把图片放入背景布中。

|  参数         |     值                                  |          说明                                           |
|---------------|-----------------------------------------|---------------------------------------------------------|
| `/canvas/`    | `<width>x<height>axay`，如600x400a50a20 | 画布尺寸，其中 width 表示画布宽，height 表示画布高，x、y 表示图片左上角在画布中的坐标  |
| `/cvscolor/`  | RRGGBBAA，如 FF000000（红色不透明）     | 边框颜色和透明度，默认值是 FFFFFF00（白色不透明）               |

注：
> `RRGGBBAA` 前面6位 `RRGGBB` 表示边框颜色；后2位 `AA` 表示不透明度，取值 `[0-255]` ，值越大越透明，00 表示完全不透明，FF 表示完全透明。


#### 静态图渐变

为静态图片添加渐变效果。

|  参数            |     值                              |          说明                      |
|------------------|-------------------------------------|------------------------------------|
| `/gdori/`        | 方向，如 top-down（自上而下）       | 渐变方向，取值见 *「注 1」*            |
| `/gdpos/`        | 开始位置,结束位置，如 10,100        | 渐变从开始位置至结束位置。单位像素（px）  |
| `/gdstartcolor/` | RRGGBBAA，如 FF000000（红色不透明） | 开始位置颜色及透明度，取值见 *「注 2」*        |
| `/gdstopcolor/`  | RRGGBBAA，如 FF000000（红色不透明） | 开始位置颜色及透明度，取值见 *「注 2」*        |

> 注 1：`gdori` 方向：`top-down`（自上而下）、`bottom-up`（自下而上）、`left-right`（自左向右）、`right-left`（自右向左）。
>
> 注 2：`RRGGBBAA` 前面 6 位 `RRGGBB` 表示边框颜色；后 2 位 `AA` 表示不透明度，取值 `[0-255]`，值越大越透明，00 表示完全不透明，FF 表示完全透明。

### 属性获取

#### 图片信息

|  参数       |     值             |          说明             |
|-------------|--------------------|-------------------------- |
| `/info`     |  无                | 获取图片宽高、格式、帧数  |
| `/meta`     |  无                | EXIF 信息 + 基本信息      |

注：
>
> - 上传处理图片默认会返回基本信息。
>
> - 上传处理通过 `x-gmkerl-type: get_meta` 获取。


#### 主题色提取

|  参数            |     值                   |          说明                                        |
|------------------|--------------------------|------------------------------------------------------|
| `/excolor/`      | 颜色数量，如 128         | 提取的颜色数量。可选值：1-4096 种                    |
| `/exformat/`     | 颜色进制，如 hex         | 返回颜色的进制，默认 hex。可选值：dec（十进制），hex（十六进制）  |

注：

> - 以 JSON 格式返回颜色。hex（十六进制）表示颜色为 `0xRRGGBB`，如 `0xff00aa`；dec（十进制）表示颜色为 `12345678`。默认为 `hex`。

> - 上传预处理通过 `x-gmkerl-type: get_theme_color` 获取；自定义颜色数量通过 `x-gmkerl-extract-color-count: 颜色数量` 设置；自定义颜色格式通过 `x-gmkerl-extract-format: hex` 设置。

### 结果输出

|  参数       |     值             |          说明             |
|-------------|--------------------|-------------------------- |
| `/format/`  |  jpg、png、webp    | 输出格式                  |
| `/quality/` | 整数值，如 75      | 设置压缩质量，可选范围`[1-99]`  *[注 1]* |
| `/compress/` | true               | 支持格式：JPG、PNG     *[注 2]*     |
| `/progressive/` | true               | JPG 图片渐进式加载，图片加载从模糊到清晰 |
| `/noicc/`    | true               | 清除图片 ICC 信息，默认 false    *[注 3]*  |

> 注 1：
> 一般来说，最佳质量值是 75，在这个值压缩大小与图片质量损失得到平衡。
> 
> 注 2：
> 进行一次压缩以减少图片体积，会稍微延长图片处理时间。
>
> 注 3：
> 清除 `ICC` 信息会导致图片轻微的失真。

### 扩展功能

|  参数        |     值             |          说明               |
|--------------|--------------------|-----------------------------|
| `/gifto/`    | true               | 多帧 gif 图片转为单帧 gif 图片  |
| `/exifswitch/` | true               | 保留 EXIF 信息               |

注：
> 图片处理默认情况下删除 `EXIF` 信息。如果需要获取 `EXIF` 信息，请参考 [获取 EXIF 信息](/cloud/image/#_19)。

