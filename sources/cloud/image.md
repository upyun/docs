## 使用方法

### URL 作图

将图片处理参数加在图片 URL 后面，就可以访问到图片处理服务，处理服务根据处理参数对图片进行处理，返回相应效果的图片。

例如，图片 URL 是:  `http://demo.b0.upaiyun.com/demo.jpg`，需要把图片旋转 90 度

访问的 URL 是： 

```
http://demo.b0.upaiyun.com/demo.jpg!/rotate/90
``` 

其中， `!` 是间隔标识符； `/rotate/90` 是处理参数，表示对图片旋转 90 度。

因此，**URL 作图的调用格式**为：

```
「图片 URL + 间隔标识符 + 处理参数」
```

特别地，处理参数是以  `/key/value` 的方式进行使用的，如果有多个处理参数，可以按 `/key1/value1/key2/value2/key3/value3` 的方式进行连接。

例如，对图片进行 90 度旋转并且加上绿色的文字水印『你好又拍云』，可以访问以下 URL：

```
http://demo.b0.upaiyun.com/demo.jpg!/rotate/90/watermark/text/5L2g5aW95Y+I5ouN5LqR/color/00ff00
```

注：


- 所有处理参数的说明，请见 [作图参数](/cloud/image/#_7)。
- 间隔标识符用于分隔图片 URL 和图片处理参数，有 3 种可选，分别是：`!`（感叹号/默认值）、`-`（中划线）和 `_`（下划线），可登录又拍云控制台，在 「服务」 > 「功能配置」 > 「云处理」 中设置。本文档使用 `!` 作为示例间隔标识符。
- 作图参数需要加在图片文件名后面而不是 URL 参数后面。例如 URL 是 `http://demo.b0.upaiyun.com/demo.jpg?foo=1&bar=2`，则加上作图参数后的 URL 应该是 `http://demo.b0.upaiyun.com/demo.jpg!/rotate/90?foo=1&bar=2`。



### 上传作图

#### 上传同步作图

如果您需要在图片上传的时候，把图片处理成有相应效果的图片并保存至又拍云存储，可以使用上传同步作图。

它通过在图片的上传请求中附加图片处理参数，当图片上传完成后，自动进行处理并保存处理后的图片。

上传作图的参数名为 `x-gmkerl-thumb`，在使用 REST API 进行图片上传时，该参数需要带在 [http 请求头](/api/rest_api/#_5) 里，而在使用 FORM API 进行图片上传时，该参数应该包含在 [policy 算法](/api/form_api/#api_1) 中。参数（`x-gmkerl-thumb`）的值与 [URL 作图](/cloud/image/#url) 的处理参数相同。

以下是几个上传同步作图的参数示例：

例1：转换图片格式为 png

```
x-gmkerl-thumb: /format/png
```

例2：限定图片宽度为 300px、锐化、压缩质量 80、存储为 png 格式（参数不区分先后顺序）

```
x-gmkerl-thumb: /fw/300/unsharp/true/quality/80/format/png
```

所有处理参数的说明，请见 [作图参数](/cloud/image/#_7)。

#### 上传异步作图

如果您需要在图片上传的时候，把图片处理成一张或多张图片，并保存原图和作图结果图至又拍云存储，可以使用上传异步作图。

它通过在 [表单 API](/api/form_api/#api_1) 的 `apps` 参数里添加异步作图任务，并指定任务名称 `name` 为 `thumb`，即可实现在图片上传完成之后自动发起 [异步图片处理任务](/api/form_api/#_4)。

特别地，上传的那张图片（原图）的保存，通过表单 API 的 `save_key` 参数来设定。

异步作图任务的参数及说明如下：

```
{
    "name": "thumb",  // 需要指定 name 为 thumb
    "x-gmkerl-thumb": "<图片处理参数，与上传作图或 URL 作图的处理参数相同>",
    "x-gmkerl-split": "<图片分块参数，分块后图片宽x高, 即 wxh>",
    "save_as": "<处理后的图片的存放地址>",
    "notify_url": "<处理完成后的回调地址>"
}
```
注：

- `x-gmkerl-split` 会在 `x-gmkerl-thumb` 的基础上对图片进行分块，用户可以根据回调信息中的行号跟列号来确定分块后的图片在原图中的位置。
- 当输出多个图片时，图片存放路径为 `$save_as-图片序号.文件后缀名`。例如， `save_as` 为 `/upyun/img.jpg`，输出 3 张图片的存放路径为 `/upyun/img.jpg-1.jpg` 、 `/upyun/img.jpg-2.jpg` 、 `/upyun/img.jpg-3.jpg`。

异步作图任务的回调信息为 json 格式，字段名及含义如下：

|  字段名       |   类型    |          说明             |
|---------------|---------- |---------------------------|
| `task_id`     |  string   | 异步处理任务 id（在上传时返回）|
| `bucket_name` |  string   | 文件所在空间名 |
| `status_code` |  integer  | 处理结果状态码，200 表示成功处理 |
| `imginfo`     |  map      | 输出单张图片信息 |
| `imginfos`    |  array    | 输出多张图片信息 |
| `error`       |  string   | 错误信息     |

`imginfo` 、 `imginfos` 中图片信息字段名及含义如下：

|  字段名   |   类型    |          说明             |
|-----------|-----------|---------------------------|
| `path`    |  string   |  作图结果保存路径（`save_as`参数指定）         |
| `type`    |  string   |  图片类型        |
| `width`   |  integer  |  图片宽度        |
| `height`  |  integer  |  图片高度        |
| `frame`   |  integer  |  图片帧数        |
| `row`     |  integer  |  相对于左上角的行号，从 0 开始，仅当图片分块时有效 |
| `column`  |  integer  |  相对于左上角的列号，从 0 开始，仅当图片分块时有效 |

输出单张图片的回调信息如下：

```json
{
    "task_id": "b52c96bea30646abf8170f333bbd42b9",
    "bucket_name": "upyun-demo",
    "status_code": 200,
    "imginfo": {
        "path": "/images/upyun.jpg",
        "type": "jpg",
        "width": 720,
        "height": 360,
        "frames": 1
    }
}
```

输出多张图片的回调信息如下：

```json
{
    "task_id": "b52c96bea30646abf8170f333bbd42b9",
    "bucket_name": "upyun-demo",
    "status_code": 200,
    "imginfos": [
      {
        "path": "/images/upyun.jpg-1.jpg",
        "type": "jpg",
        "width": 72,
        "height": 36,
        "frames": 1,
        "row": 0,
        "column": 0
      },
      {
        "path": "/images/upyun.jpg-2.jpg",
        "type": "jpg",
        "width": 72,
        "height": 36,
        "frames": 1,
        "row": 0,
        "column": 1
      }
    ]
}
```

#### 原图保护秘钥

如果您不希望用户访问到原图，可以给原图加上保护秘钥。

图片上传时，原图保护秘钥通过 `Content-Secret` 设置，具体 API 的使用方式点 [REST API](/api/rest_api/#_4) | [FORM API](/api/form_api/#api_1) 查看。

对已经存在存储的图片，可以通过编辑 `metadata 信息` 设置保护密钥，具体使用方式点 [REST API](/api/rest_api/#metadata) 查看。

图片添加保护秘钥后，访问时需要带上间隔标识符与秘钥，才能访问原图。假设原图秘钥是 `abc`,访问原图为：

```
http://demo.b0.upaiyun.com/demo.jpg!abc
``` 

对加保护秘钥的图片进行图片处理，不需要加保护秘钥。如果保护秘钥跟缩略图版本名称相同，视作保护密钥。


### 缩略图版本作图

如果您觉得写 `/fw/300/unsharp/true/quality/80/format/png` 这样一串作图参数比较麻烦，可以为它定义一个缩略图版本，使用时通过缩略图版本名称来替代冗长的作图参数。

例如，我们为 `/fw/300/unsharp/true/quality/80/format/png` 配置了一个缩略图版本，名称为 `upyun123`

URL 使用缩略图版本为： 

```
http://demo.b0.upaiyun.com/demo.jpg!upyun123
``` 

上传使用缩略图版本为：

```
x-gmkerl-thumb: upyun123
``` 

注：

- 缩略图版本通过 「又拍云控制台」 > 「服务」 > 「功能配置」 > 「云处理」 > 「自定义版本」  进行设置。
- 使用缩略图版本与使用原始的作图参数对图片的处理效果是相同的。
- 作图参数是以 `/` 开头的，如 `/fw/100/quality/90`，缩略图版本不是以 `/` 开头的，上例中如果错误地使用了 `/test` 会返回 *400 参数错误*。


### 混合作图

上例中，我们配置了 `upyun123` 这个缩略图版本，它会对图片进行限定宽度 300px 的操作（`/fw/300`），当某张图片需要限定宽度 100px 而其他都不变时，修改这个缩略图版本会影响到其他已经使用这个版本的图片的处理效果，重新创建一个缩略图版本又显得有些麻烦。

针对这种情景，又拍云提供了缩略图版本与作图参数混合的作图方式，在使用缩略图版本时通过作图参数对它进行动态调整。

例如，通过 `upyun123` 实现 `/fw/100/unsharp/true/quality/80/format/png` 的作图效果

URL 使用混合作图为：

```
http://demo.b0.upaiyun.com/demo.jpg!upyun123/fw/100
``` 

上传使用混合作图为： 

```
x-gmkerl-thumb: upyun123/fw/100
```

注：

- 作图参数只能出现在缩略图版本的后面，如 `upyun123/fw/100`。
- 缩略图版本中与作图参数中存在相同的参数时，最后出现的参数优先级最高。如上例中，`upyun123` 中存在 `/fw/300`，作图参数中存在 `/fw/100`，处理时以最后出现的 `/fw/100` 为准。

## 作图参数

### 基本参数

#### 缩放

|  参数     |     值                |          说明                                            |
|-----------|----------------------|----------------------------------------------------------|
| `/fw/`    | 宽，如 300            | 限定宽度，高度自适应                                   |
| `/fh/`    | 高，如 200            | 限定高度，宽度自适应                                    |
| `/max/`   | 最长边，如 200         | 限定最长边，短边自适应                                 |
| `/min/`   | 最短边，如 200         | 限定最短边，长边自适应                                   |
| `/fwfh/`  | 宽x高，如 300x200      | 限定宽度或高度，宽高不足时不缩放   *「注-1」*           |
| `/both/`  | 宽x高，如 300x200      | 固定宽度和高度，宽高不足时居中裁剪再缩放 <br /> 特别地，配合 `/force/true` 使用时，宽高不足时只缩放，不裁剪   |
| `/sq/`    | 宽或高，如 300            | 图片缩放成正方形，宽高相等                      |
| `/scale/` | 缩放比例，如 50           | 宽高等比例缩放，取值范围 [1-1000]   *「注-2」*                |
| `/wscale/` | 宽度缩放比例，如 200      | 宽度按比例缩放，高度不变，取值范围 [1-1000]          |
| `/hscale/` | 高度缩放比例，如 200      | 高度按比例缩放，宽度不变，取值范围 [1-1000]          |
| `/fxfn/`   | 宽x高，如 300x200        | 限定长边或短边，进行等比缩放，不裁剪               |
| `/fxfn2/`  | 宽x高，如 300x200        | 限定长边或短边的最小值，进行等比缩放，不裁剪               |
| `/fp/`     | 宽高像素积，如 200000   | 宽高等比例缩放，直到宽高像素积小于但最接近指定值，取值范围 [1-25000000] |
| `/force/`  | true                    | 不支持放大的参数，可以指定 `/force/` 为 `true` 进行图片放大，默认是 `false` *「注-3」*  |

注：

1. `/fwfh/` 当原图宽与期望缩放的宽的比例大于原图高与期望缩放的高的比例时，是 `/fw/`；否则，是 `/fh/`。
2. `/scale/` 值取 `20` 时，缩小后的图片宽高是原图宽高的 `20%`；取 `200` 时，放大后的图片宽高是原图宽高的 `200%`。
3. 为了保持兼容，大部分缩放参数默认不支持放大，需要放大，请指定 `/force/true` 。
4. 特别的，图片处理输入的图片宽、高最大不能超过 2 万像素，宽 * 高的像素积最大不能超过 2 亿。


#### 裁剪

|  参数     |     值                                            |          说明                                                            |
|-----------|-------------------------------------------------- |------------------------------------------------------------------------- |
| `/crop/`  | `<width>x<height>a<x>a<y>` 如 `300x200a80s60`     | 图片缩放前裁剪 |
| `/clip/`  | `<width>x<height>a<x>a<y>` 如 `300x200s80a60`     | 图片缩放后裁剪 |
| `/gravity` | 位置，如 `north`  | 裁剪开始的方位，默认是 `northwest`，方位的说明见水印*「注-4」* |

注：

- `<width>x<height>` 中的 `x`，是英文字母 `x`，`<width>`、`<height>` 表示裁剪图片宽、高。特别地，当 `<width>x<height>` 是 `0x0` 时，自动根据偏移量计算裁剪图片宽、高。
- `a<x>s<y>` 中的 `<x>`、`<y>` 表示偏移量，`a`、`s` 表示正、负，`x` 正负判断依据是：往 `east` 方向偏移，为 `a`；往 `west` 方向偏移，为 `s`; `y` 正负判断依据是：往 `south` 方向偏移，为 `a`；往 `north` 方向偏移，为 `s`。


#### 水印

> **水印参数需要以 `/watermark` 开头，然后加上水印参数。**如 `/watermark/text/5L2g5aW977yB`。

** 图片水印 **

|  参数         |     值                                            |          说明                                                        |
|---------------|---------------------------------------------------|---------------------------------------------------------------------------|
| `/url/`       | 编码字符串，如 `L3BhdGgvdG8vd2F0ZXJtYXJrLnBuZw==` | 水印图片的 URI，示例为 `/path/to/watermark.png` 的编码字符串*「注-1」* <br /> 特别地，水印图片必须放在原图所在服务名下。  |
| `/align/`     | 位置，如 north                                   | 水印图片放置方位，默认 `northwest` *「注-4」*                                     |
| `/margin/`    | 横偏移x纵偏移，如 15x10                           | 水印图片横纵相对偏移，默认 `20x20`                                               |
| `/opacity/`   | 透明度，如 90                                    | 水印图片透明度，默认 `100`，取值范围 `[0-100]`，值越大越不透明，`0` 完全透明，`100` 完全不透明 |
| `/animate/`   | true                                            | 允许对动态图片加水印，默认 `false`  |


** 文字水印 **

|  参数         |     值                                     |          说明                                                      |
|---------------|------------------------------------------- |--------------------------------------------------------------------|
| `/text/`      | 文字内容，如 `5L2g5aW977yB`                | 文字内容，示例中为 `你好！`的编码字符串。 *「注-3」*                       |
| `/size/`      | 大小，如 16                               | 文字大小，单位 px，默认 `32`                                              |
| `/font/`      | 字体，如 simsun（宋体）                    | 文字字体，默认宋体。字体使用时，用参数名。详见 [字体支持列表](/cloud/attachment/#_3)  
| `/color/`     | RRGGBB，如 FF0000（红色）                  | 字体颜色，默认 `000000`（黑色）                                            |
| `/border/`    | RRGGBBAA，如 FF000000（不透明红色）        | 文字描边，默认 `FFFFFFFF`（透明白色）*「注-5」*                                   |
| `/align/`     | 位置，如 north                            | 文字放置方位，默认 `northwest` *「注-4」*                                    |
| `/margin/`    | 横偏移x纵偏移，如 15x10                    | 文字横纵相对偏移，默认 `20x20`                                             |
| `/opacity/`   | 透明度，如 90                              | 文字透明度，默认 `100`，取值范围 `[0-100]`，值越大越不透明，`0` 完全透明，`100` 完全不透明 |
| `/animate/`   | true                                      | 允许对动态图片加水印，默认 `false`   |


** 多个水印 **

通过指定多个 `/watermark` 参数，可以在原图上打多个图片水印或文字水印。

例如，打一个文字水印和一个图片水印的参数如下：
```
/watermark/text/5L2g5aW977yB/font/simhei/watermark/url/L3BhdGgvdG8vd2F0ZXJtYXJrLnBuZw==/align/center/opacity/50
```
当然，水印个数越多，处理耗时就会越长，建议不要超过 3 个。

注：

- 1、图片水印的 `url` 需要 base64 编码，并把编码后字符串中的 `/`（斜杠）替换成 `|`（竖线）。
- 2、文字水印中含中文内容时请使用中文字体，否则内容会乱码。
- 3、`text` 内容需要 base64 编码，并把编码后字符串中的 `/`（斜杠）替换成 `|`（竖线）。
- 4、水印/裁剪的对齐方式：（ 共 9 个方位 ）

```
    northwest     |     north      |     northeast
                  |                |
                  |                |
    --------------+----------------+--------------
                  |                |
    west          |     center     |          east
                  |                |
    --------------+----------------+--------------
                  |                |
                  |                |
    southwest     |     south      |     southeast
```

- 5、`RRGGBBAA` 前面 6 位 `RRGGBB` 表示边框颜色；后 2 位 `AA` 表示不透明度，取值 `[0-255]`，值越大越透明，`00` 表示完全不透明，`FF` 表示完全透明。


#### 旋转

|  参数       |     值                  |          说明               |
|-------------|------------------------ |-----------------------------|
| `/rotate/`  | auto                    | 自动扶正                    |
| `/rotate/`  | `(0, 360]`，如 90 度      | 按角度旋转                  |

#### 翻转

|  参数        |     值                |          说明                          |
|--------------|-----------------------|----------------------------------------|
| `/flip/`     | 方向，如 left,right   | 翻转方向，可选值：`left,right`，`top,down` |

注：

- `left,right`：从左向右翻转，`top,down`：从上向下翻转。


### 图片渲染

#### 锐化

提高图片模糊部位的清晰度或聚焦程度。

|  参数        |     值                 |          说明               |
|--------------|------------------------|-----------------------------|
| `/unsharp/`  | true                   | 锐化，默认 false            |

#### 高斯模糊

减少图片噪音以及降低图片细节层次，让图片模糊化。

|  参数         |     值                      |          说明                               |
|---------------|-----------------------------|---------------------------------------------|
| `/gaussblur/` | `<radius>x<sigma>`，如 5x2  | 高斯模糊，radius 为模糊半径，sigma 为标准差 |

注：

- `<radius>x<sigma>`中的 `x`，是英文字母 `x`。
- `0 <= radius <= 50` 且 `radius` 是整数；当 `radius = 0` 时，`raduis` 根据 `sigma` 自动计算产生。
- `sigma` 必须为正整数。

#### 边框

为图片添加边框，支持设置边框颜色。

|  参数         |     值                              |          说明                             |
|---------------|-------------------------------------|-------------------------------------------|
| `/border/`    | `<width>x<height>`，如 3x2          | 边框尺寸，width 表示左右边框宽度，height 表示上下边框宽度     |
| `/brdcolor/`  | RRGGBBAA，如 FF000000（红色不透明） | 边框颜色和透明度，默认值是 FFFFFF00（白色不透明） |

注：

- `RRGGBBAA` 前面6位 `RRGGBB` 表示边框颜色；后2位 `AA` 表示不透明度，取值 `[0-255]`，值越大越透明，00 表示完全不透明，FF 表示完全透明。

#### 画布

为图片添加画布，相当于把图片放入背景布中。

|  参数         |     值                                  |          说明                                           |
|---------------|-----------------------------------------|---------------------------------------------------------|
| `/canvas/`    | `<width>x<height>axay`，如600x400a50a20 | 画布尺寸，其中 width 表示画布宽，height 表示画布高，x、y 表示图片左上角在画布中的坐标  |
| `/cvscolor/`  | RRGGBBAA，如 FF000000（红色不透明）     | 边框颜色和透明度，默认值是 FFFFFF00（白色不透明）               |

注：

- `RRGGBBAA` 前面6位 `RRGGBB` 表示边框颜色；后2位 `AA` 表示不透明度，取值 `[0-255]` ，值越大越透明，00 表示完全不透明，FF 表示完全透明。


#### 静态图渐变

为静态图片添加渐变效果。

|  参数            |     值                              |          说明                      |
|------------------|-------------------------------------|------------------------------------|
| `/gdori/`        | 方向，如 top,down（自上而下）       | 渐变方向，取值见 *「注 1」*            |
| `/gdpos/`        | 开始位置,结束位置，如 10,100        | 渐变从开始位置至结束位置。单位像素（px）  |
| `/gdstartcolor/` | RRGGBBAA，如 FF000000（红色不透明） | 开始位置颜色及透明度，取值见 *「注 2」*        |
| `/gdstopcolor/`  | RRGGBBAA，如 FF000000（红色不透明） | 开始位置颜色及透明度，取值见 *「注 2」*        |

注：

- `gdori` 方向：`top,down`（自上而下）、`bottom,up`（自下而上）、`left,right`（自左向右）、`right,left`（自右向左）。
- `RRGGBBAA` 前面 6 位 `RRGGBB` 表示边框颜色；后 2 位 `AA` 表示不透明度，取值 `[0-255]`，值越大越透明，00 表示完全不透明，FF 表示完全透明。

### 属性获取

#### 图片信息

|  参数       |     值             |          说明             |
|-------------|--------------------|-------------------------- |
| `/info`     |  无                | 获取基本信息（宽高、格式、帧数）  |
| `/meta`     |  无                | 获取 EXIF 信息 + 基本信息      |
| `/meta/iptc`     |  无                | 获取 IPTC 信息 + 基本信息      |
| `/meta/all`     |  无                | 获取图片所有信息，当前是 EXIF 信息 + IPTC 信息 + 基本信息      |

注：

- 上传作图时默认返回图片基本信息，相当于 `/info` 。
- `/meta` 在[上传作图](/cloud/image/#_2)时需要写成 `x-gmkerl-type: get_meta` 。
- `/meta/iptc` 与 `/meta/all` 不支持上传作图，仅支持 [URL 作图](/cloud/image/#url)。
- `/meta/all` 获取到的图片信息会随着平台支持的信息种类增多而扩展，请您在使用时注意。


#### 主题色提取

|  参数            |     值                   |          说明                                        |
|------------------|--------------------------|------------------------------------------------------|
| `/excolor/`      | 颜色数量，如 128         | 提取的颜色数量。可选值：1-4096 种                    |
| `/exformat/`     | 颜色进制，如 hex         | 返回颜色的进制，默认 hex。可选值：dec（十进制），hex（十六进制）  |

注：

- 以 JSON 格式返回颜色。hex（十六进制）表示颜色为 `0xRRGGBB`，如 `0xff00aa`；dec（十进制）表示颜色为 `12345678`。默认为 `hex`。
- 上传预处理通过 `x-gmkerl-type: get_theme_color` 获取；自定义颜色数量通过 `x-gmkerl-extract-color-count: 颜色数量` 设置；自定义颜色格式通过 `x-gmkerl-extract-format: hex` 设置。

### 结果输出

|  参数       |     值             |          说明             |
|-------------|-------------------|-------------------------- |
| `/format/`  |  jpg              | 输出格式，可选值 jpg、png、webp <br />支持的输入格式有 jpg、jpeg、png、webp、gif、动态 gif、bmp、svg 等                  |
| `/quality/` | 整数值，如 75      | 设置压缩质量，可选范围`[1-99]`  *[注 1]* |
| `/compress/` | true             | 开启 JPG 、 PNG 大小压缩优化，默认 false     *[注 2]*     |
| `/coalesce/` | false            | 动态 GIF 大小压缩优化，默认 true     *[注 4]*     |
| `/progressive/` | true          | JPG 图片渐进式加载，图片加载从模糊到清晰 |
| `/noicc/`    | true             | 清除图片 ICC 信息，默认 false    *[注 3]*  |
| `/strip/`    | true             | 去除图片所有元信息，包括 exif 、icc 等。默认是 `false`  |

注：

1. 一般来说，最佳质量值是 75，在这个值压缩大小与图片质量损失得到平衡。
2. 进行一次压缩以减少图片体积，会稍微延长图片处理时间，同时图片会有微小的质量损失。
3. 清除 `ICC` 信息会导致图片轻微的失真。
4. `/coalesce/` 为 `true` 时，不开启优化方式，图片变大但质量不会有损失；为 `false` 时，开启优化方式，图片变小但质量会有微小的损失。

### 扩展功能

|  参数        |     值             |          说明               |
|--------------|--------------------|-----------------------------|
| `/gifto/`    | true               | 多帧 gif 图片转为单帧 gif 图片  |
| `/exifswitch/` | true               | 保留 EXIF 信息               |

注：

- 图片处理默认情况下删除 `EXIF` 信息。如果需要获取 `EXIF` 信息，请参考 [获取 EXIF 信息](/cloud/image/#_19)。

